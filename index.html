<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Basketly - Risparmia sulla tua spesa con un click</title>
    <style>
        /* ensure consistent sizing to avoid overflow / overlap */
        *, *::before, *::after { box-sizing: border-box; }

        :root{
            --primary-color:#27ae60;
            --bg-color:#f3f4f6;
            --text-color:#1a1a1a;
            --card-bg:#ffffff;
            --danger-color:#e74c3c;
            --esselunga:#1c3c6d;
            --lidl:#0050AA;
            --carrefour:#1e5bc6;
            --tigros:#0066cc;
            --conad:#da291c;
        }

        html,body{height:100%}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
            background-color:var(--bg-color);
            margin:0;
            color:var(--text-color);
            padding-bottom:calc(110px + env(safe-area-inset-bottom));
            -webkit-font-smoothing:antialiased;
        }

        header{
            background:white;
            padding:15px 20px 20px;
            position:sticky;
            top:0;
            z-index:100;
            box-shadow:0 4px 15px rgba(0,0,0,0.05);
            border-bottom-left-radius:20px;
            border-bottom-right-radius:20px;
        }

        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .logo{font-weight:900;font-size:1.6rem;color:var(--primary-color);letter-spacing:-1px}
        .logo span{color:#2c3e50}
        .location-badge{background:#f1f3f4;padding:8px 12px;border-radius:12px;font-size:0.9rem;font-weight:600;display:flex;align-items:center;gap:5px;cursor:pointer}
        .location-badge:focus{outline:2px solid rgba(39,174,96,0.2);}

        .geo-row{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:0.85rem}
        .geo-row input[type="text"]{padding:8px 10px;border-radius:10px;border:1px solid #ddd;font-size:0.85rem;min-width:220px;flex:1 1 220px}
        .geo-btn{padding:8px 12px;border-radius:10px;border:none;background:var(--primary-color);color:white;font-size:0.8rem;font-weight:600;cursor:pointer}
        .geo-status{font-size:0.8rem;color:#555}
        .range-box{display:flex;align-items:center;gap:8px;background:#f1f3f4;padding:6px 10px;border-radius:999px}
        .range-box input[type="range"]{width:140px}
        .range-value{font-weight:600;font-size:0.85rem;min-width:55px;text-align:right}

        /* SEARCH + FILTER layout: prevent overlap by using flex with min-width:0 and responsive stacking */
        .search-row{display:flex;gap:10px;margin-top:10px;align-items:center;flex-wrap:nowrap}
        .search-box{flex:1 1 auto;min-width:0} /* min-width:0 important so input can shrink inside flex */
        .search-box input{
            width:100%;padding:14px 15px 14px 20px;border:2px solid #eee;border-radius:14px;font-size:1rem;outline:none;
            background:#f9f9f9;
        }
        .filter-box{flex:0 0 160px;min-width:120px}
        .filter-box select{padding:10px 12px;border-radius:14px;border:2px solid #eee;background:#f9f9f9;font-size:0.9rem;outline:none;width:100%}

        /* max savings box (used in results modal now) */
        .max-savings-box{
            margin-top:8px;
            background: linear-gradient(90deg, rgba(39,174,96,0.08), rgba(39,174,96,0.03));
            border:1px solid rgba(39,174,96,0.12);
            padding:10px 14px;
            border-radius:12px;
            display:flex;
            align-items:center;
            gap:12px;
            color:var(--primary-color);
            font-weight:700;
            font-size:0.96rem;
            box-shadow:0 6px 18px rgba(39,174,96,0.06);
        }
        .max-savings-box .ms-value{font-size:1.1rem;color:var(--primary-color);font-weight:900}
        .max-savings-box .ms-detail{font-size:0.85rem;color:#4b5563;font-weight:600}

        /* product grid */
        .product-grid{
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
            gap:15px;
            padding:20px;
        }
        .product-card{background:var(--card-bg);border-radius:16px;padding:15px;box-shadow:0 4px 6px rgba(0,0,0,0.03);display:flex;flex-direction:column;align-items:center;text-align:center}
        .product-icon{font-size:3.5rem;margin-bottom:10px}
        .product-name{font-weight:700;font-size:0.9rem;line-height:1.3;margin-bottom:4px;height:2.4em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
        .product-size{font-size:0.75rem;color:#888;margin-bottom:12px}
        .controls{display:flex;width:100%;gap:8px;margin-top:auto}
        .btn-main{flex-grow:1;background:var(--text-color);color:white;border:none;padding:10px 0;border-radius:10px;font-weight:600;font-size:0.85rem;cursor:pointer}
        .btn-main.added{background:var(--primary-color)}
        .btn-minus{display:none;width:38px;background:#fee2e2;color:var(--danger-color);border:none;border-radius:10px;font-weight:800;font-size:1.2rem;cursor:pointer;align-items:center;justify-content:center;height:38px}
        .product-card[data-added="true"] .btn-minus{display:flex}

        /* -------------------- BOTTOM BAR (compact + overlay panel) -------------------- */
        .bottom-bar{
            position:fixed;
            left:0;right:0;bottom:0;
            background:white;
            display:flex;
            align-items:center;
            gap:12px;
            z-index:1200;
            border-top:1px solid #eee;
            box-shadow:0 -6px 18px rgba(0,0,0,0.08);
            padding:10px 14px;
            height:auto;
            min-height:52px;
            box-sizing:border-box;
        }

        .basket-summary{
            display:flex;
            flex-direction:row;
            align-items:center;
            gap:10px;
            flex:0 0 auto;
            min-width:0;
        }
        .basket-count{font-weight:800;font-size:1.02rem;white-space:nowrap}
        .basket-link{font-size:0.78rem;text-decoration:underline;cursor:pointer;color:#555;white-space:nowrap}

        .bottom-controls{
            display:flex;
            align-items:center;
            gap:8px;
            flex:1 1 auto;
            justify-content:flex-end;
            flex-wrap:nowrap;
            min-width:0;
        }

        .pill-btn{
            display:inline-flex;
            align-items:center;
            gap:8px;
            background:#f1f3f4;
            border-radius:999px;
            padding:6px 10px;
            font-size:0.85rem;
            border:none;
            cursor:pointer;
            color:#333;
            flex:0 0 auto;
            min-width:90px;
            box-sizing:border-box;
        }
        .pill-btn .pill-icon{font-size:0.95rem}
        .pill-btn .pill-text{display:inline-block}
        .pill-btn select{border:none;background:transparent;font-size:0.85rem;outline:none;cursor:pointer}

        .toggle-complete{display:inline-flex;align-items:center;gap:6px;background:#f1f3f4;border-radius:999px;padding:6px 10px;font-size:0.78rem;flex:0 0 auto;cursor:pointer;transition:background .15s;min-width:0;max-width:100%}
        .toggle-complete .label-text { font-weight:600; font-size:0.78rem; color: #333; display:inline-block; white-space:nowrap; max-width:120px; overflow:hidden; text-overflow:ellipsis;}
        .toggle-complete .toggle-switch{position:relative;width:34px;height:18px;background:#d1d5db;border-radius:999px;cursor:pointer}
        .toggle-complete .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-complete .toggle-knob{position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:white;transition:transform .18s}
        .toggle-complete .toggle-switch input:checked + .toggle-knob{transform:translateX(16px)}

        /* visual state when checkbox is checked is controlled by parent .active class */
        .toggle-complete.active{background:var(--primary-color); color:white}
        .toggle-complete.active .label-text{color:white}
        .toggle-complete.active .toggle-knob{background:white}

        .compare-btn{
            background:var(--primary-color);
            color:white;
            border:none;
            padding:10px 14px;
            border-radius:14px;
            font-weight:700;
            font-size:0.95rem;
            box-shadow:0 6px 14px rgba(39,174,96,0.25);
            cursor:pointer;
            white-space:nowrap;
            flex:0 0 auto;
            min-width:110px;
            max-width:240px;
            text-align:center;
            box-sizing:border-box;
            overflow:hidden;
            text-overflow:ellipsis;
        }

        .collapse-toggle{
            background:transparent;border:none;cursor:pointer;padding:6px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#555;flex:0 0 auto;
        }
        .collapse-toggle .chev{transition:transform .18s}
        .bottom-bar.expanded .collapse-toggle .chev{transform:rotate(180deg)}

        /* HIDE inline controls in the bottom bar when overlay is open (explicit rule) */
        .bottom-bar.expanded .pill-btn,
        .bottom-bar.expanded .toggle-complete {
            display: none !important;
        }

        /* overlay controls panel shown on mobile when expanded */
        .controls-panel{
            display:none;
        }
        /* mark panel visible when bottom-bar has 'expanded' and only on mobile */
        @media (max-width:720px){
            .controls-panel{
                position:fixed;
                left:12px;
                right:12px;
                bottom:calc(62px + env(safe-area-inset-bottom));
                background:white;
                border-radius:14px;
                box-shadow:0 10px 30px rgba(0,0,0,0.12);
                padding:10px;
                z-index:1199;
                display:none;
            }
            .bottom-bar.expanded + .controls-panel { display:block; }

            /* when collapsed: hide inline pill & toggle (we use overlay) */
            .bottom-bar:not(.expanded) .pill-btn,
            .bottom-bar:not(.expanded) .toggle-complete {
                display:none;
            }

            /* make compare button slightly wider when collapsed so it's easier to tap */
            .bottom-bar:not(.expanded) .compare-btn {
                min-width:130px;
                padding:10px 18px;
            }

            /* when expanded via overlay, keep compare button compact */
            .bottom-bar.expanded .compare-btn {
                min-width:110px;
            }

            /* ensure product grid not obscured */
            .product-grid{padding-bottom:230px}

            /* stack search + filter vertically on smaller screens to avoid overlap */
            .search-row{flex-direction:column;align-items:stretch;gap:8px}
            .filter-box{flex:0 0 auto;width:100%}
            .search-box{width:100%}
        }

        /* Additional tweaks specifically for very small screens (fix overflow and overlap) */
        @media (max-width:480px){
            /* ensure toggle and pill are full-width and don't overflow their white container */
            .bottom-controls{flex-wrap:wrap;gap:6px;}
            .pill-btn{width:100%;}
            .toggle-complete{width:100%;justify-content:space-between;padding:8px 10px;box-sizing:border-box;}
            .bottom-bar{padding-left:10px;padding-right:10px;}
            .compare-btn{
                min-width:100px;
                padding:8px 12px;
                font-size:0.92rem;
            }

            /* Make the label text wrap instead of overflowing */
            .toggle-complete .label-text{white-space:normal;max-width:70%;}
            .toggle-complete{justify-content:space-between;}

            /* small adjustments so elements never overflow container */
            .bottom-controls > *{max-width:100%;box-sizing:border-box;}
        }

        /* desktop: show inline controls and hide overlay always */
        @media (min-width:721px){
            .controls-panel{display:none}
            .product-grid{padding-bottom:120px}
        }

        /* Modals and other components */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:2000}
        .modal-card{position:absolute;bottom:0;width:100%;max-height:85vh;background:#f9fafb;border-radius:24px 24px 0 0;overflow-y:auto;animation:slideUp 0.3s ease-out;box-sizing:border-box}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-header{position:sticky;top:0;background:white;padding:20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;z-index:10}
        .close-icon{font-size:1.5rem;cursor:pointer;background:none;border:none;padding:5px}
        .basket-list{padding:20px}
        .basket-item{background:white;padding:15px;border-radius:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.02)}
        .b-icon{font-size:2rem;margin-right:15px;width:40px;text-align:center}
        .b-qty-control{display:flex;align-items:center;gap:8px;background:#f3f4f6;padding:5px;border-radius:8px}
        .b-btn{width:28px;height:28px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .b-minus{background:white;color:var(--danger-color)}
        .b-plus{background:white;color:var(--primary-color)}

        .result-card{background:white;border-radius:16px;padding:20px;margin:20px;box-shadow:0 4px 10px rgba(0,0,0,0.05);position:relative;border:2px solid transparent}
        .result-card.best{border-color:var(--primary-color);background:#f0fdf4}
        .best-badge{position:absolute;top:-10px;right:20px;background:var(--primary-color);color:white;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:800}
        .store-row{display:flex;align-items:center;gap:15px;margin-bottom:15px;border-bottom:1px dashed #eee;padding-bottom:15px}
        .store-avatar{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:1.2rem;box-shadow:0 2px 5px rgba(0,0,0,0.1);flex:0 0 50px}
        .s-esselunga{background-color:var(--esselunga);color:#ffcc00;position:relative}
        .s-esselunga:after{content:"S";position:absolute;top:-5px;font-size:1.5rem}
        .s-lidl{background-color:var(--lidl);color:#FFF000;border-bottom:4px solid #E60A14}
        .s-carrefour{background-color:var(--carrefour)}
        .s-tigros{background-color:var(--tigros);border-bottom:4px solid #ffd700}
        .s-conad{background-color:white;border:2px solid var(--conad);color:var(--conad)}
        .total{font-size:1.5rem;font-weight:800;text-align:right;margin-top:10px;color:var(--text-color)}

        .toggle-btn{width:100%;background:none;border:none;color:#666;font-size:0.85rem;padding:10px;margin-top:10px;border-top:1px solid #eee;cursor:pointer;text-align:center;font-weight:600}
        .breakdown-list{background:#f9f9f9;margin-top:10px;padding:10px;border-radius:8px;display:none}
        .breakdown-row{display:flex;justify-content:space-between;font-size:0.85rem;padding:4px 0;border-bottom:1px dashed #eee}
        .breakdown-row:last-child{border-bottom:none}
        .bd-price{font-weight:600;color:#333}

        .meta-small{font-size:0.75rem;color:#586069;margin-top:6px}
        .meta-small .source{font-weight:700;color:#333}
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo">Basketly<span>.</span></div>
        <div id="locationBadge" class="location-badge" role="button" tabindex="0" aria-expanded="true" title="Mostra/Nascondi impostazione posizione">
            üìç <span id="geoLabel">Posizione non impostata</span>
        </div>
    </div>

    <div id="geoRow" class="geo-row">
        <input type="text" id="addressInput" placeholder="Inserisci indirizzo (es. Via Candiani 131, Milano)" size="35">
        <div class="range-box">
            <span style="font-size:0.8rem;">Raggio</span>
            <input type="range" id="radiusSlider" min="1" max="10" step="0.5" value="3" oninput="updateRadiusLabel(this.value)">
            <span class="range-value" id="radiusLabel">3.0 km</span>
        </div>
        <button class="geo-btn" onclick="setUserLocation()">Imposta posizione</button>
        <span class="geo-status" id="geoStatus"></span>
    </div>

    <div class="search-row">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Cerca prodotti...">
        </div>
        <div class="filter-box">
            <select id="typeFilter">
                <option value="all">Tutti i prodotti</option>
                <option value="perishable">Prodotti deperibili (freschi)</option>
                <option value="household">Prodotti casa & cura</option>
                <option value="longlife">Prodotti lunga conservazione</option>
            </select>
        </div>
    </div>

    <!-- Nota: il box di risparmio √® stato rimosso dall'header e sar√† mostrato nella pagina di confronto (modal) -->
</header>

<div class="product-grid" id="productGrid"></div>

<!-- bottom bar -->
<div class="bottom-bar" role="navigation" aria-label="Barra inferiore" id="bottomBar">
    <div class="basket-summary">
        <span class="basket-count" id="barCount">0 Articoli</span>
        <span class="basket-link" onclick="toggleModal('basketModal')">Apri/Modifica Carrello</span>
    </div>

    <div class="bottom-controls" id="bottomControls">
        <!-- collapse control placed to the LEFT of Confronta as requested -->
        <button class="collapse-toggle" id="collapseToggle" aria-label="Espandi/Nascondi opzioni" title="Mostra/Nascondi opzioni">
            <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <button class="compare-btn" onclick="runComparison()" id="compareBtn">Confronta ‚ö°</button>

        <div class="pill-btn" id="pillInline" title="Ordina">
            <span class="pill-icon">‚ÜïÔ∏è</span>
            <span class="pill-text">Ordina</span>
            <select id="sortMode">
                <option value="price">Prezzo</option>
                <option value="distance">Distanza</option>
                <option value="mixed">Mix ‚Ç¨ / km</option>
            </select>
        </div>

        <label class="toggle-complete" id="toggleCompleteLabel" title="Mostra solo carrelli completi">
            <span class="label-text">Mostra solo carrelli completi</span>
            <div class="toggle-switch" style="margin-left:8px;">
                <input type="checkbox" id="onlyComplete">
                <div class="toggle-knob"></div>
            </div>
        </label>
    </div>
</div>

<div class="controls-panel" id="controlsPanel" aria-hidden="true">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div style="flex:1; min-width:120px;">
            <button class="pill-btn" type="button" aria-label="Ordina e opzioni (overlay)">
                <span class="pill-icon">‚ÜïÔ∏è</span>
                <span class="pill-text">Ordina</span>
                <select id="sortModeOverlay" aria-label="Modalit√† di ordinamento overlay">
                    <option value="price">Prezzo</option>
                    <option value="distance">Distanza</option>
                    <option value="mixed">Mix ‚Ç¨ / km</option>
                </select>
            </button>
        </div>
        <div style="flex:1; min-width:150px;">
            <label class="toggle-complete" id="toggleCompleteLabelOverlay" title="Mostra solo carrelli completi (overlay)" style="width:100%;justify-content:space-between;">
                <span class="label-text">Mostra solo carrelli completi</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="onlyCompleteOverlay" aria-label="Mostra solo carrelli completi overlay">
                    <div class="toggle-knob"></div>
                </div>
            </label>
        </div>
    </div>
</div>

<div class="modal" id="basketModal">
    <div class="modal-card">
        <div class="modal-header">
            <h2 style="margin:0">Il tuo Carrello</h2>
            <button class="close-icon" onclick="toggleModal('basketModal')" aria-label="Chiudi">‚úï</button>
        </div>
        <div class="basket-list" id="basketListContainer"></div>
    </div>
</div>

<div class="modal" id="resultsModal">
    <div class="modal-card">
        <div class="modal-header" style="flex-direction:column;align-items:flex-start;gap:8px;">
            <div style="width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;">
                <div style="flex:1; min-width:0;">
                    <h2 style="margin:0">Migliori Prezzi</h2>
                    <div id="savingsSummary" style="font-size:0.8rem;color:#555;margin-top:4px"></div>
                </div>
                <button class="close-icon" onclick="toggleModal('resultsModal')" aria-label="Chiudi">‚úï</button>
            </div>

            <!-- Il box di risparmio √® ora qui, nella pagina di confronto (modal) -->
            <div id="maxSavingsBox" class="max-savings-box" aria-live="polite" style="display:none; width:100%;">
                <div class="ms-value" id="msValue">‚Ç¨0.00</div>
                <div class="ms-detail" id="msDetail">Esempio di risparmio potenziale</div>
            </div>
        </div>

        <div id="resultsContainer" style="padding-bottom:40px"></div>
    </div>
</div>

<script>
const products = [
        { id: 1, category: "Ortofrutta", type: "perishable", name: "Mele Golden", size: "1kg", icon: "üçè",
          prices: { esselunga: 2.08, lidl: 2.23, carrefour: 2.50, tigros: 2.32, conad: 2.28 } },
        { id: 2, category: "Ortofrutta", type: "perishable", name: "Banane", size: "1kg", icon: "üçå",
          prices: { esselunga: 1.72, lidl: 1.61, carrefour: 1.93, tigros: 1.79, conad: 1.76 } },
        { id: 3, category: "Ortofrutta", type: "perishable", name: "Insalata Mista in Busta", size: "200g", icon: "ü•¨",
          prices: { esselunga: 1.33, lidl: 1.32, carrefour: 1.23, tigros: 1.39, conad: 1.34 } },
        { id: 10, category: "Carne", type: "perishable", name: "Petto di Pollo a Fette", size: "500g", icon: "üçó",
          prices: { esselunga: 5.60, lidl: 5.54, carrefour: 6.26, tigros: 5.22, conad: 5.71 } },
        { id: 11, category: "Carne", type: "perishable", name: "Macinato di Manzo", size: "500g", icon: "ü•©",
          prices: { esselunga: 5.40, lidl: 5.50, carrefour: 6.03, tigros: 5.61, conad: 5.03 } },
        { id: 12, category: "Carne", type: "perishable", name: "Fettine di Vitello", size: "400g", icon: "ü•©",
          prices: { esselunga: 7.12, lidl: 7.64, carrefour: 8.54, tigros: 7.94, conad: 7.79 } },
        { id: 20, category: "Pesce", type: "perishable", name: "Salmone Fresco a Tranci", size: "300g", icon: "üêü",
          prices: { esselunga: 8.15, lidl: 7.59, carrefour: 9.11, tigros: 8.47, conad: 8.31 } },
        { id: 21, category: "Pesce", type: "perishable", name: "Filetti di Merluzzo Freschi", size: "400g", icon: "üêü",
          prices: { esselunga: 6.68, lidl: 6.62, carrefour: 6.17, tigros: 7.01, conad: 6.75 } },
        { id: 22, category: "Pesce", type: "perishable", name: "Gamberi Sgusciati", size: "250g", icon: "ü¶ê",
          prices: { esselunga: 6.11, lidl: 6.05, carrefour: 6.89, tigros: 5.87, conad: 6.23 } },
        { id: 30, category: "Salumi/Formaggi", type: "perishable", name: "Prosciutto Cotto Rovagnati", size: "120g", icon: "ü•ì",
          prices: { esselunga: 2.27, lidl: 2.44, carrefour: 2.63, tigros: 2.51, conad: 2.49 } },
        { id: 31, category: "Salumi/Formaggi", type: "perishable", name: "Prosciutto Crudo di Parma", size: "100g", icon: "ü•ì",
          prices: { esselunga: 3.25, lidl: 3.03, carrefour: 3.51, tigros: 3.37, conad: 3.30 } },
        { id: 32, category: "Salumi/Formaggi", type: "perishable", name: "Mozzarella Galbani Santa Lucia", size: "3x100g", icon: "üßÄ",
          prices: { esselunga: 3.09, lidl: 3.05, carrefour: 2.84, tigros: 3.23, conad: 3.11 } },
        { id: 40, category: "Gastronomia", type: "perishable", name: "Lasagne Pronte al Rag√π", size: "1 porzione", icon: "üç≤",
          prices: { esselunga: 5.24, lidl: 5.09, carrefour: 5.85, tigros: 4.74, conad: 5.43 } },
        { id: 41, category: "Gastronomia", type: "perishable", name: "Insalata di Riso Pronta", size: "300g", icon: "ü•ó",
          prices: { esselunga: 3.56, lidl: 3.63, carrefour: 3.99, tigros: 3.71, conad: 3.65 } },
        { id: 42, category: "Gastronomia", type: "perishable", name: "Pollo allo Spiedo", size: "1 pezzo", icon: "üçó",
          prices: { esselunga: 7.59, lidl: 8.39, carrefour: 9.11, tigros: 8.47, conad: 8.31 } },
        { id: 50, category: "Latticini", type: "perishable", name: "Latte Parzialmente Scremato Granarolo", size: "1L", icon: "ü•õ",
          prices: { esselunga: 1.39, lidl: 1.42, carrefour: 1.58, tigros: 1.48, conad: 1.44 } },
        { id: 51, category: "Latticini", type: "perishable", name: "Yogurt Bianco M√ºller", size: "2x125g", icon: "ü•£",
          prices: { esselunga: 1.16, lidl: 1.12, carrefour: 1.13, tigros: 1.21, conad: 1.13 } },
        { id: 52, category: "Latticini", type: "perishable", name: "Burro Galbani Santa Lucia", size: "250g", icon: "üßà",
          prices: { esselunga: 2.37, lidl: 2.54, carrefour: 2.84, tigros: 2.65, conad: 2.62 } },
        { id: 60, category: "Panetteria", type: "perishable", name: "Pane Casereccio", size: "500g", icon: "üçû",
          prices: { esselunga: 2.30, lidl: 2.34, carrefour: 2.63, tigros: 2.09, conad: 2.38 } },
        { id: 61, category: "Panetteria", type: "perishable", name: "Baguette", size: "300g", icon: "ü•ñ",
          prices: { esselunga: 1.52, lidl: 1.43, carrefour: 1.82, tigros: 1.59, conad: 1.55 } },
        { id: 62, category: "Panetteria", type: "perishable", name: "Brioche Vuota", size: "1 pezzo", icon: "ü•ê",
          prices: { esselunga: 1.04, lidl: 1.10, carrefour: 1.28, tigros: 1.16, conad: 1.15 } },
        { id: 70, category: "Surgelati", type: "longlife", name: "Buitoni Pizza Margherita Surgelata", size: "350g", icon: "üçï",
          prices: { esselunga: 2.56, lidl: 2.74, carrefour: 3.07, tigros: 2.85, conad: 2.77 } },
        { id: 71, category: "Surgelati", type: "longlife", name: "Verdure Miste Surgelate", size: "600g", icon: "ü•¶",
          prices: { esselunga: 2.54, lidl: 2.37, carrefour: 2.86, tigros: 2.68, conad: 2.60 } },
        { id: 72, category: "Surgelati", type: "longlife", name: "Gelato Alla Vaniglia", size: "500ml", icon: "üç®",
          prices: { esselunga: 3.46, lidl: 3.56, carrefour: 3.78, tigros: 3.31, conad: 3.61 } },
        { id: 80, category: "Dispensa", type: "longlife", name: "Barilla Spaghetti N.5", size: "500g", icon: "üçù",
          prices: { esselunga: 1.13, lidl: 1.21, carrefour: 1.41, tigros: 1.29, conad: 1.24 } },
        { id: 81, category: "Dispensa", type: "longlife", name: "De Cecco Spaghetti", size: "500g", icon: "üçù",
          prices: { esselunga: 1.52, lidl: 1.42, carrefour: 1.64, tigros: 1.57, conad: 1.53 } },
        { id: 82, category: "Dispensa", type: "longlife", name: "Rummo Spaghetti N.3", size: "500g", icon: "üçù",
          prices: { esselunga: 1.74, lidl: 1.72, carrefour: 1.61, tigros: 1.83, conad: 1.76 } },
        { id: 83, category: "Dispensa", type: "longlife", name: "Barilla Penne Rigate", size: "500g", icon: "üçù",
          prices: { esselunga: 1.13, lidl: 1.21, carrefour: 1.41, tigros: 1.29, conad: 1.24 } },
        { id: 84, category: "Dispensa", type: "longlife", name: "De Cecco Penne Rigate", size: "500g", icon: "üçù",
          prices: { esselunga: 1.52, lidl: 1.42, carrefour: 1.64, tigros: 1.57, conad: 1.53 } },
        { id: 85, category: "Dispensa", type: "longlife", name: "La Molisana Penne Rigate", size: "500g", icon: "üçù",
          prices: { esselunga: 1.43, lidl: 1.47, carrefour: 1.59, tigros: 1.38, conad: 1.50 } },
        { id: 90, category: "Dispensa", type: "longlife", name: "Riso Arborio Scotti", size: "1kg", icon: "üçö",
          prices: { esselunga: 2.82, lidl: 2.74, carrefour: 3.07, tigros: 2.85, conad: 2.77 } },
        { id: 91, category: "Dispensa", type: "longlife", name: "Cirio Passata di Pomodoro", size: "700g", icon: "üçÖ",
          prices: { esselunga: 1.63, lidl: 1.61, carrefour: 1.51, tigros: 1.70, conad: 1.66 } },
        { id: 92, category: "Dispensa", type: "longlife", name: "Mutti Passata di Pomodoro", size: "700g", icon: "üçÖ",
          prices: { esselunga: 1.73, lidl: 1.77, carrefour: 1.61, tigros: 1.83, conad: 1.76 } },
        { id: 93, category: "Dispensa", type: "longlife", name: "Rio Mare Tonno all'Olio di Oliva 3x80g", size: "3x80g", icon: "üêü",
          prices: { esselunga: 4.61, lidl: 4.58, carrefour: 4.83, tigros: 4.64, conad: 4.56 } },
        { id: 94, category: "Dispensa", type: "longlife", name: "Manzotin Carne in Gelatina", size: "140g", icon: "ü•´",
          prices: { esselunga: 2.40, lidl: 2.39, carrefour: 2.27, tigros: 2.48, conad: 2.45 } },
        { id: 95, category: "Dispensa", type: "longlife", name: "Barilla Sugo Pronto all'Arrabbiata", size: "400g", icon: "üçÖ",
          prices: { esselunga: 2.17, lidl: 2.31, carrefour: 2.51, tigros: 2.32, conad: 2.29 } },
        { id: 96, category: "Dispensa", type: "longlife", name: "Borlotti in Scatola Valfrutta", size: "400g", icon: "ü´ò",
          prices: { esselunga: 1.14, lidl: 1.11, carrefour: 1.08, tigros: 1.19, conad: 1.13 } },
        { id: 97, category: "Dispensa", type: "longlife", name: "Cracker Salati Saiwa", size: "500g", icon: "üßÇ",
          prices: { esselunga: 2.08, lidl: 2.23, carrefour: 2.50, tigros: 2.32, conad: 2.28 } },
        { id: 98, category: "Snack/Dolci", type: "longlife", name: "Mulino Bianco Pan di Stelle", size: "350g", icon: "‚≠ê",
          prices: { esselunga: 3.09, lidl: 3.25, carrefour: 3.41, tigros: 2.89, conad: 3.17 } },
        { id: 99, category: "Dispensa", type: "longlife", name: "Pomodori Pelati Mutti", size: "400g", icon: "üß∫",
          prices: { esselunga: 1.32, lidl: 1.38, carrefour: 1.64, tigros: 1.47, conad: 1.42 } },
        { id: 100, category: "Snack/Dolci", type: "longlife", name: "San Carlo Patatine Classiche", size: "180g", icon: "ü•î",
          prices: { esselunga: 1.81, lidl: 1.74, carrefour: 1.96, tigros: 1.87, conad: 1.83 } },
        { id: 101, category: "Snack/Dolci", type: "longlife", name: "Pavesi Gocciole", size: "500g", icon: "üç™",
          prices: { esselunga: 2.80, lidl: 2.72, carrefour: 3.18, tigros: 2.46, conad: 2.86 } },
        { id: 102, category: "Snack/Dolci", type: "longlife", name: "Tavoletta di Cioccolato Novi Fondente", size: "100g", icon: "üç´",
          prices: { esselunga: 1.73, lidl: 1.82, carrefour: 1.93, tigros: 1.66, conad: 1.76 } },
        { id: 110, category: "Colazione", type: "longlife", name: "Kellogg's Corn Flakes", size: "375g", icon: "ü•£",
          prices: { esselunga: 2.51, lidl: 2.28, carrefour: 2.74, tigros: 2.46, conad: 2.39 } },
        { id: 111, category: "Colazione", type: "longlife", name: "Mulino Bianco Fette Biscottate Integrali", size: "320g", icon: "üçû",
          prices: { esselunga: 1.99, lidl: 2.19, carrefour: 2.28, tigros: 1.85, conad: 1.90 } },
        { id: 112, category: "Colazione", type: "longlife", name: "Crema Spalmabile alla Nocciola Nutella", size: "450g", icon: "üç´",
          prices: { esselunga: 4.44, lidl: 4.19, carrefour: 4.90, tigros: 4.63, conad: 4.52 } },
        { id: 120, category: "Bevande", type: "longlife", name: "Acqua Naturale 1,5L", size: "1.5L", icon: "üíß",
          prices: { esselunga: 0.37, lidl: 0.36, carrefour: 0.43, tigros: 0.39, conad: 0.41 } },
        { id: 121, category: "Bevande", type: "longlife", name: "Bibita Tipo Cola", size: "1.5L", icon: "ü•§",
          prices: { esselunga: 1.39, lidl: 1.01, carrefour: 1.57, tigros: 1.47, conad: 1.42 } },
        { id: 122, category: "Bevande", type: "longlife", name: "Succo di Arancia 100%", size: "1L", icon: "üßÉ",
          prices: { esselunga: 1.85, lidl: 1.76, carrefour: 2.04, tigros: 1.93, conad: 1.83 } },
        { id: 123, category: "Bevande", type: "longlife", name: "T√® Freddo Pesca Lipton 1,5L", size: "1.5L", icon: "üßã",
          prices: { esselunga: 1.86, lidl: 1.76, carrefour: 2.04, tigros: 1.66, conad: 1.83 },
          availability: { esselunga: true, lidl: true, carrefour: true, tigros: true, conad: false } },
        { id: 130, category: "Cura Casa", type: "household", name: "Nelsen Detersivo Piatti", size: "900ml", icon: "üßº",
          prices: { esselunga: 2.30, lidl: 2.03, carrefour: 2.63, tigros: 2.32, conad: 2.28 } },
        { id: 131, category: "Cura Casa", type: "household", name: "Dash Detersivo Lavatrice Liquido", size: "25 lavaggi", icon: "üß¥",
          prices: { esselunga: 6.75, lidl: 6.57, carrefour: 7.39, tigros: 6.14, conad: 6.63 } },
        { id: 132, category: "Cura Casa", type: "household", name: "Scottex Carta Assorbente da Cucina", size: "2 rotoli", icon: "üìú",
          prices: { esselunga: 2.56, lidl: 2.77, carrefour: 3.08, tigros: 2.74, conad: 2.67 } },
        { id: 140, category: "Cura Persona", type: "household", name: "Head & Shoulders Shampoo", size: "250ml", icon: "üß¥",
          prices: { esselunga: 3.66, lidl: 3.05, carrefour: 4.08, tigros: 3.69, conad: 3.58 } },
        { id: 141, category: "Cura Persona", type: "household", name: "Mentadent Dentifricio", size: "75ml", icon: "ü™•",
          prices: { esselunga: 1.99, lidl: 2.43, carrefour: 2.51, tigros: 2.00, conad: 2.09 } },
        { id: 142, category: "Cura Persona", type: "household", name: "Felce Azzurra Bagnoschiuma", size: "650ml", icon: "üõÅ",
          prices: { esselunga: 2.99, lidl: 3.05, carrefour: 3.65, tigros: 2.84, conad: 3.11 } },
        { id: 150, category: "Animali", type: "household", name: "Monge Crocchette per Cani", size: "1.5kg", icon: "üê∂",
          prices: { esselunga: 5.03, lidl: 5.09, carrefour: 6.15, tigros: 5.56, conad: 5.51 },
          availability: { esselunga: true, lidl: true, carrefour: true, tigros: true, conad: true } },
        { id: 151, category: "Animali", type: "household", name: "Monge Crocchette per Gatti", size: "1.5kg", icon: "üê±",
          prices: { esselunga: 5.65, lidl: 5.60, carrefour: 5.22, tigros: 5.93, conad: 5.71 },
          availability: { esselunga: true, lidl: true, carrefour: true, tigros: false, conad: true } },
        { id: 152, category: "Animali", type: "household", name: "Lettiera per Gatti Agglomerante", size: "5kg", icon: "üß∫",
          prices: { esselunga: 5.09, lidl: 5.04, carrefour: 5.69, tigros: 4.74, conad: 5.19 },
          availability: { esselunga: true, lidl: false, carrefour: true, tigros: true, conad: true } },
        { id: 160, category: "Casalinghi", type: "household", name: "Pellicola Trasparente", size: "30m", icon: "üì¶",
          prices: { esselunga: 1.93, lidl: 1.97, carrefour: 2.15, tigros: 2.00, conad: 1.80 } },
        { id: 161, category: "Casalinghi", type: "household", name: "Sacchetti Immondizia 50L", size: "20 pezzi", icon: "üóëÔ∏è",
          prices: { esselunga: 2.08, lidl: 2.23, carrefour: 2.50, tigros: 2.32, conad: 2.28 },
          availability: { esselunga: true, lidl: true, carrefour: false, tigros: true, conad: true } },
        { id: 162, category: "Casalinghi", type: "household", name: "Batterie AAA Alcaline (4 pezzi)", size: "4pz", icon: "üîã",
          prices: { esselunga: 3.56, lidl: 3.32, carrefour: 3.98, tigros: 3.70, conad: 3.63 } }
];


    const stores = {
        esselunga:{name:"Esselunga",class:"s-esselunga",short:"E"},
        lidl:{name:"Lidl",class:"s-lidl",short:"L"},
        carrefour:{name:"Carrefour",class:"s-carrefour",short:"C"},
        tigros:{name:"Tigros",class:"s-tigros",short:"T"},
        conad:{name:"Conad",class:"s-conad",short:"C"}
    };

    const storeLocations = {
        esselunga:{lat:45.485,lon:9.228},
        lidl:{lat:45.493,lon:9.210},
        carrefour:{lat:45.462,lon:9.196},
        tigros:{lat:45.505,lon:9.160},
        conad:{lat:45.474,lon:9.214}
    };

    let basket = {};
    let userLocation = null;

    function getRadiusKm(){const s=document.getElementById("radiusSlider");return parseFloat(s.value)}
    function updateRadiusLabel(v){document.getElementById("radiusLabel").innerText=parseFloat(v).toFixed(1)+" km"}

    function distanceKm(lat1,lon1,lat2,lon2){
        const R=6371;const toRad=d=>d*Math.PI/180;
        const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
        const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        return R*c;
    }

    /* --- fake timestamp & source helpers --- */
    function pad(n){return(n<10?'0':'')+n}
    function getStoreBaseDate(storeKey){
        const now=new Date();
        let seed=0;
        for(let i=0;i<storeKey.length;i++) seed+=storeKey.charCodeAt(i);
        const minutesOffset=(seed%180);
        return new Date(now.getTime()-minutesOffset*60*1000);
    }
    function fakeTimestampForPrice(storeKey,productId){
        const base=getStoreBaseDate(storeKey);
        const extra=productId%45;
        const d=new Date(base.getTime()-extra*60*1000);
        return formatFriendlyTimestamp(d);
    }
    function formatFriendlyTimestamp(d){
        const now=new Date();
        const sameDay=d.getDate()===now.getDate()&&d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
        const hh=pad(d.getHours()); const mm=pad(d.getMinutes());
        if(sameDay) return `oggi ‚Äì ore ${hh}:${mm}`;
        const dd=pad(d.getDate()); const mmn=pad(d.getMonth()+1);
        return `${dd}/${mmn} ‚Äì ore ${hh}:${mm}`;
    }
    function fakeTimestampForStore(storeKey){ return formatFriendlyTimestamp(getStoreBaseDate(storeKey)); }
    function fakeSourceForStore(storeKey){ return `Volantino ${stores[storeKey].name} (demo)`; }
    /* --- end helpers --- */

    async function setUserLocation(){
        const addr=document.getElementById("addressInput").value.trim();
        const radius=getRadiusKm();
        const statusEl=document.getElementById("geoStatus");
        if(!addr){alert("Inserisci un indirizzo.");return;}
        if(isNaN(radius)||radius<=0){alert("Inserisci un raggio in km valido.");return;}
        statusEl.innerText="Geocodifica indirizzo in corso...";
        try{
            const q=encodeURIComponent(addr+", Milano, Italia");
            const url=`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`;
            const resp=await fetch(url,{headers:{"Accept":"application/json"}}); const data=await resp.json();
            if(!data||data.length===0){statusEl.innerText="Indirizzo non trovato."; return;}
            const loc=data[0];
            userLocation={lat:parseFloat(loc.lat),lon:parseFloat(loc.lon)};
            document.getElementById("geoLabel").innerText=`Posizione impostata: ${addr}`;
            statusEl.innerText=`Coordinate: ${userLocation.lat.toFixed(5)}, ${userLocation.lon.toFixed(5)} (raggio ${radius.toFixed(1)} km)`;
            // clear previous max savings until user triggers a new comparison
            updateMaxSavingsBox(null);

            // hide the geo-row after successful geocoding so the user sees a cleaner header
            const geoRow = document.getElementById('geoRow');
            const locationBadge = document.getElementById('locationBadge');
            if(geoRow && locationBadge){
                geoRow.style.display = 'none';
                locationBadge.setAttribute('aria-expanded', 'false');
                // update title to indicate it can be riaperto
                locationBadge.title = "Posizione impostata ‚Äî clicca per modificare / riaprire";
            }
        }catch(e){console.error(e);statusEl.innerText="Errore durante la geocodifica."}
    }

    function renderProducts(){
        const grid=document.getElementById("productGrid");
        const searchVal=(document.getElementById("searchInput")?.value || '').toLowerCase();
        const typeFilter=document.getElementById("typeFilter")?.value || 'all';
        grid.innerHTML="";
        const filtered=products.filter(p=>{
            const matchesSearch=p.name.toLowerCase().includes(searchVal);
            let matchesType=true;
            if(typeFilter==="perishable") matchesType=p.type==="perishable";
            else if(typeFilter==="household") matchesType=p.type==="household";
            else if(typeFilter==="longlife") matchesType=p.type==="longlife";
            return matchesSearch && matchesType;
        });
        filtered.forEach(p=>{
            const qty=basket[p.id]||0;
            const isAdded=qty>0;
            const card=document.createElement("div");
            card.className="product-card";
            card.setAttribute("data-added",isAdded);
            card.innerHTML=`
                <div class="product-icon">${p.icon || 'üçΩÔ∏è'}</div>
                <div class="product-name">${p.name}</div>
                <div class="product-size">${p.size || ''}</div>
                <div class="controls">
                    <button class="btn-minus" onclick="updateQty(${p.id}, -1)">‚àí</button>
                    <button class="btn-main ${isAdded?'added':''}" onclick="updateQty(${p.id}, 1)">
                        ${isAdded?`${qty} nel carrello`:"Aggiungi +"}
                    </button>
                </div>
            `;
            grid.appendChild(card);
        });
        updateSummary();
    }

    function updateQty(id,delta){
        if(!basket[id]) basket[id]=0;
        basket[id]+=delta;
        if(basket[id]<=0) delete basket[id];
        renderProducts();
        renderBasketList();
        // clear max savings box when basket changes (user should re-run confronto)
        updateMaxSavingsBox(null);
    }

    function updateSummary(){
        const count=Object.values(basket).reduce((a,b)=>a+b,0);
        document.getElementById("barCount").innerText=`${count} Articoli`;
    }

    function toggleModal(id){
        const el=document.getElementById(id);
        if(el.style.display==="block") el.style.display="none";
        else{ if(id==='basketModal') renderBasketList(); el.style.display="block"; }
    }

    function toggleBreakdown(key){
        const el=document.getElementById('bd-'+key);
        const btn=document.getElementById('btn-'+key);
        if(!el) return;
        if(el.style.display==='none'){ el.style.display='block'; if(btn) btn.innerText='‚¨Ü Chiudi dettagli'; }
        else { el.style.display='none'; if(btn) btn.innerText='‚¨á Vedi dettaglio spesa'; }
    }

    function renderBasketList(){
        const container=document.getElementById("basketListContainer");
        container.innerHTML="";
        if(Object.keys(basket).length===0){
            container.innerHTML="<p style='text-align:center;color:#999;margin-top:30px'>Il carrello √® vuoto.</p>";
            return;
        }
        Object.keys(basket).forEach(key=>{
            const p=products.find(x=>x.id==key);
            const qty=basket[key];
            container.innerHTML+=`
                <div class="basket-item">
                    <div style="display:flex;align-items:center;">
                        <div class="b-icon">${p.icon || 'üçΩÔ∏è'}</div>
                        <div>
                            <div style="font-weight:600;font-size:0.9rem">${p.name}</div>
                            <div style="font-size:0.8rem;color:#888">${p.size || ''}</div>
                        </div>
                    </div>
                    <div class="b-qty-control">
                        <button class="b-btn b-minus" onclick="updateQty(${p.id}, -1)">‚àí</button>
                        <span style="font-weight:700;width:20px;text-align:center;">${qty}</span>
                        <button class="b-btn b-plus" onclick="updateQty(${p.id}, 1)">+</button>
                    </div>
                </div>
            `;
        });
    }

    /**
     * computeBestTotalWithinRadius(centerRadiusKm, extraKm, requireComplete)
     * - requireComplete: se true, ignora (non considera) supermercati che non hanno TUTTI gli articoli del carrello disponibili
     * Restituisce { storeKey, distKm, total, missingCount } o null se nessuno applicabile.
     */
    function computeBestTotalWithinRadius(centerRadiusKm, extraKm, requireComplete = false){
        if(!userLocation) return null;
        let best = null;
        Object.keys(stores).forEach(key=>{
            const loc = storeLocations[key]; if(!loc) return;
            const dist = distanceKm(userLocation.lat, userLocation.lon, loc.lat, loc.lon);
            if(dist > centerRadiusKm + (extraKm || 0)) return;

            let total = 0;
            let missingCount = 0;
            Object.keys(basket).forEach(itemId=>{
                const p = products.find(x => x.id == itemId);
                const qty = basket[itemId];
                const availMap = p.availability || {};
                const isAvailable = (key in availMap) ? !!availMap[key] : true;
                if(isAvailable){
                    total += (p.prices && p.prices[key] ? p.prices[key] * qty : 0);
                } else {
                    missingCount += qty; // conteggiamo quantit√† mancanti
                }
            });

            if(requireComplete && missingCount > 0) return; // skip this store if incomplete and we require completeness

            // choose best by minimal total, but if equal prefer closer?
            if(best === null || total < best.total || (Math.abs(total - best.total) < 1e-6 && dist < best.distKm)){
                best = { storeKey: key, distKm: dist, total, missingCount };
            }
        });
        return best;
    }

    /**
     * findMinimalIncreaseSaving(currentBestTotal, step=0.5, maxIncrease=5, requireComplete=false)
     * - cerca il minimo incremento di raggio che porta ad un candidato con total < currentBestTotal
     * - passa requireComplete a computeBestTotalWithinRadius in modo da rispettare il filtro "carrelli completi"
     */
    function findMinimalIncreaseSaving(currentBestTotal, step = 0.5, maxIncrease = 5, requireComplete = false){
        const baseRadius = getRadiusKm();
        for(let inc = step; inc <= maxIncrease + 1e-9; inc += step){
            const cand = computeBestTotalWithinRadius(baseRadius + inc, 0, requireComplete);
            if(cand && (cand.total + 0.01) < currentBestTotal){
                return { increase: parseFloat(inc.toFixed(3)), candidate: cand };
            }
        }
        return null;
    }

    // Update the savings box inside the results modal
    function updateMaxSavingsBox(results){
        const box = document.getElementById('maxSavingsBox');
        const valEl = document.getElementById('msValue');
        const detailEl = document.getElementById('msDetail');

        if(!box || !valEl || !detailEl){
            return;
        }

        // leggi stato "onlyComplete" correntemente selezionato (sincronizza inline e overlay)
        const onlyComplete = (document.getElementById('onlyComplete')?.checked || document.getElementById('onlyCompleteOverlay')?.checked);

        if(!results || !Array.isArray(results) || results.length === 0){
            box.style.display = 'none';
            valEl.innerText = '‚Ç¨0.00';
            detailEl.innerText = '';
            return;
        }

        // se richiesto, filtra i risultati per escludere supermarket non completi
        const filtered = onlyComplete ? results.filter(r => (r.missingCount || 0) === 0) : results.slice();

        if(filtered.length === 0){
            // nessun supermercato completo tra i risultati ‚Äî nascondi il box
            box.style.display = 'none';
            valEl.innerText = '‚Ç¨0.00';
            detailEl.innerText = '';
            return;
        }

        const best = filtered.reduce((acc, r) => (acc === null || r.total < acc.total) ? r : acc, null);
        const worst = filtered.reduce((acc, r) => (acc === null || r.total > acc.total) ? r : acc, null);

        if(!best || !worst){
            box.style.display = 'none';
            return;
        }

        const diff = worst.total - best.total;
        if(diff <= 0.005){
            box.style.display = 'none';
            return;
        }

        box.style.display = 'flex';
        valEl.innerText = `‚Ç¨${diff.toFixed(2)}`;
        detailEl.innerText = `Risparmio massimo (tra supermercati ${onlyComplete ? 'completi' : 'tutti'}): passando da ${worst.meta.name} (‚Ç¨${worst.total.toFixed(2)}) a ${best.meta.name} (‚Ç¨${best.total.toFixed(2)}).`;
    }

    function runComparison(){
        if(Object.keys(basket).length===0){ alert("Il carrello √® vuoto!"); return; }
        if(!userLocation){ alert("Imposta prima una posizione (indirizzo)."); return; }
        const radius=getRadiusKm();
        if(isNaN(radius)||radius<=0){ alert("Raggio km non valido."); return; }

        const resultsModal=document.getElementById("resultsModal");
        const container=document.getElementById("resultsContainer");
        container.innerHTML="";
        const savingsEl=document.getElementById("savingsSummary");
        const sortMode=document.getElementById("sortMode")?.value || document.getElementById("sortModeOverlay")?.value;
        const onlyComplete=document.getElementById("onlyComplete")?.checked || document.getElementById("onlyCompleteOverlay")?.checked;
        const results=[];

        Object.keys(stores).forEach(key=>{
            const loc=storeLocations[key]; if(!loc) return;
            const dist=distanceKm(userLocation.lat, userLocation.lon, loc.lat, loc.lon);
            if(dist>radius) return;

            let total=0;
            let breakdownHtml=`<div class="breakdown-list" id="bd-${key}" style="display:none;">`;
            let missingHtml="";
            const missingItems=[];
            const groupedLines={};
            const categoryOrder=["Ortofrutta","Carne","Pesce","Salumi/Formaggi","Gastronomia","Latticini","Panetteria","Surgelati","Dispensa","Snack/Dolci","Colazione","Bevande","Cura Casa","Cura Persona","Animali","Casalinghi","Altro"];

            Object.keys(basket).forEach(itemId=>{
                const p=products.find(x=>x.id==itemId);
                const qty=basket[itemId];
                const availMap=p.availability||{};
                const isAvailable=(key in availMap)?!!availMap[key]:true;
                const cat=p.category||"Altro";
                if(!groupedLines[cat]) groupedLines[cat]=[];

                const ts=fakeTimestampForPrice(key,p.id);
                const src=fakeSourceForStore(key);

                if(isAvailable){
                    const price = (p.prices && p.prices[key]) ? p.prices[key] : 0;
                    const itemTotal=price*qty; total+=itemTotal;
                    groupedLines[cat].push(`
                        <div style="padding:6px 0;">
                            <div class="breakdown-row"><span>${qty}x ${p.name}</span><span class="bd-price">‚Ç¨${itemTotal.toFixed(2)}</span></div>
                            <div class="meta-small">Aggiornato il: ${ts} ¬∑ Fonte: <span class="source">${src}</span></div>
                        </div>
                    `);
                } else {
                    missingItems.push(p);
                    const line=`
                        <div style="padding:6px 0;">
                            <div class="breakdown-row" style="color:#b91c1c;"><span>${qty}x ${p.name}</span><span class="bd-price">NON DISP.</span></div>
                            <div class="meta-small" style="color:#b91c1c;">Aggiornato il: ${ts} ¬∑ Fonte: <span class="source">${src}</span></div>
                        </div>
                    `;
                    groupedLines[cat].push(line);
                    missingHtml+=line;
                }
            });

            if(onlyComplete && missingItems.length>0) return;

            const cats=Object.keys(groupedLines).sort((a,b)=>{
                const ia=categoryOrder.indexOf(a), ib=categoryOrder.indexOf(b);
                return (ia===-1?999:ia)-(ib===-1?999:ib);
            });

            cats.forEach(cat=>{
                breakdownHtml+=`<div style="font-size:0.8rem;font-weight:700;margin-top:6px;margin-bottom:2px;">${cat}</div>`;
                groupedLines[cat].forEach(line=>breakdownHtml+=line);
            });

            if(missingItems.length>0){
                breakdownHtml+=`<div style="margin-top:8px;padding-top:8px;border-top:1px dashed #fca5a5;">
                    <div style="font-size:0.8rem;font-weight:700;color:#b91c1c;margin-bottom:4px;">‚ö† Prodotti non disponibili in questo supermercato:</div>
                    ${missingHtml}
                </div>`;
            }

            breakdownHtml+=`</div>`;

            results.push({
                key, meta:stores[key], distKm:dist, total, missingCount:missingItems.length, breakdown:breakdownHtml
            });
        });

        if(results.length===0){
            container.innerHTML="<p style='padding:20px;text-align:center;color:#555'>Nessun supermercato entro il raggio selezionato.</p>";
            savingsEl.innerText="";
            updateMaxSavingsBox(null);
            resultsModal.style.display="block";
            return;
        }

        results.sort((a,b)=>{
            if(sortMode==="distance") return a.distKm-b.distKm;
            if(sortMode==="mixed"){ const scoreA=a.total+a.distKm*0.8, scoreB=b.total+b.distKm*0.8; return scoreA-scoreB; }
            return a.total-b.total;
        });

        const bestCurrent=results[0];

        // Try to find the minimal radius increase (up to 5 km) that yields a cheaper total
        const found = findMinimalIncreaseSaving(bestCurrent.total, 0.5, 5, onlyComplete);

        if(found){
            const inc = found.increase;
            const saved = (bestCurrent.total - found.candidate.total);
            const storeName = stores[found.candidate.storeKey] ? stores[found.candidate.storeKey].name : found.candidate.storeKey;
            savingsEl.innerText = `Aumentando il raggio di ${inc.toFixed(1)} km puoi risparmiare circa ‚Ç¨${saved.toFixed(2)} includendo ${storeName}.`;
        } else {
            // No better store found within the tested extra radius: fallback to showing best total in selected radius
            const bestTotal=bestCurrent.total.toFixed(2);
            savingsEl.innerText=`Miglior totale nel raggio selezionato: ‚Ç¨${bestTotal}.`;
        }

        // aggiorna il box superiore DELLA PAGINA DI CONFRONTO (modal), tenendo conto di onlyComplete
        updateMaxSavingsBox(results);

        results.forEach((res,idx)=>{
            const isBest=idx===0;
            const hasMissing=res.missingCount>0;
            const storeTs=fakeTimestampForStore(res.key);
            const storeSrc=fakeSourceForStore(res.key);
            container.innerHTML+=`
                <div class="result-card ${isBest?'best':''}">
                    ${isBest?`<div class="best-badge">üèÜ MIGLIORE</div>`:''}
                    <div class="store-row">
                        <div class="store-avatar ${res.meta.class}">${res.meta.short}</div>
                        <div style="flex:1;min-width:0;">
                            <h3 style="margin:0;font-size:1.1rem">${res.meta.name}</h3>
                            <div style="font-size:0.85rem;color:#777">Distanza: ${res.distKm.toFixed(1)} km</div>
                            <div style="font-size:0.8rem;color:#555;margin-top:6px;">Aggiornato il: ${storeTs} ¬∑ Fonte: <span style="font-weight:700;color:#333">${storeSrc}</span></div>
                            ${hasMissing?`<div style="font-size:0.8rem;color:#b91c1c;margin-top:8px;">‚ùó Alcuni prodotti del carrello non sono disponibili in questo supermercato</div>`:''}
                        </div>
                    </div>
                    <div class="total">‚Ç¨${res.total.toFixed(2)}</div>
                    <button class="toggle-btn" id="btn-${res.key}" onclick="toggleBreakdown('${res.key}')">‚¨á Vedi dettaglio spesa</button>
                    ${res.breakdown}
                </div>
            `;
        });

        resultsModal.style.display="block";
    }

    // HANDLE collapse overlay & syncing overlays/inline inputs
    const collapseToggle = document.getElementById('collapseToggle');
    const bottomBar = document.getElementById('bottomBar');
    const controlsPanel = document.getElementById('controlsPanel');

    // Toggle bottom controls overlay (mobile)
    if(collapseToggle){
        collapseToggle.addEventListener('click', () => {
            bottomBar.classList.toggle('expanded');
            // aria for controls panel
            const expanded = bottomBar.classList.contains('expanded');
            controlsPanel.setAttribute('aria-hidden', (!expanded).toString());
        });
    }

    // Sync sort selects (inline <-> overlay)
    const sortInline = document.getElementById('sortMode');
    const sortOverlay = document.getElementById('sortModeOverlay');
    if(sortInline && sortOverlay){
        sortInline.addEventListener('change', ()=>{ sortOverlay.value = sortInline.value; });
        sortOverlay.addEventListener('change', ()=>{ sortInline.value = sortOverlay.value; });
    }

    // Sync onlyComplete checkboxes and keep visual state of labels (active class)
    const onlyInline = document.getElementById('onlyComplete');
    const onlyOverlay = document.getElementById('onlyCompleteOverlay');
    const toggleLabel = document.getElementById('toggleCompleteLabel');
    const toggleLabelOverlay = document.getElementById('toggleCompleteLabelOverlay');

    function updateToggleVisual(checkbox, labelEl){
        if(!checkbox || !labelEl) return;
        if(checkbox.checked) labelEl.classList.add('active');
        else labelEl.classList.remove('active');
    }

    if(onlyInline && onlyOverlay){
        // initial sync / visual state
        updateToggleVisual(onlyInline, toggleLabel);
        updateToggleVisual(onlyOverlay, toggleLabelOverlay);
        // when inline checkbox changes -> sync overlay and update visuals
        onlyInline.addEventListener('change', ()=>{
            onlyOverlay.checked = onlyInline.checked;
            updateToggleVisual(onlyInline, toggleLabel);
            updateToggleVisual(onlyOverlay, toggleLabelOverlay);
        });
        // when overlay checkbox changes -> sync inline and update visuals
        onlyOverlay.addEventListener('change', ()=>{
            onlyInline.checked = onlyOverlay.checked;
            updateToggleVisual(onlyInline, toggleLabel);
            updateToggleVisual(onlyOverlay, toggleLabelOverlay);
        });
    }

    // Toggle the geo-row when clicking the location badge / label
    const locationBadge = document.getElementById('locationBadge');
    const geoRow = document.getElementById('geoRow');
    if(locationBadge && geoRow){
        // clicking toggles visibility; after geocoding geoRow will be hidden automatically,
        // user can reopen it by clicking the badge
        locationBadge.addEventListener('click', (e) => {
            e.preventDefault();
            const isHidden = window.getComputedStyle(geoRow).display === 'none';
            if(isHidden){
                geoRow.style.display = 'flex';
                locationBadge.setAttribute('aria-expanded', 'true');
                // focus input for convenience
                const ai = document.getElementById('addressInput');
                if(ai){ ai.focus(); ai.select(); }
            } else {
                geoRow.style.display = 'none';
                locationBadge.setAttribute('aria-expanded', 'false');
            }
        });
        // also allow keyboard toggling (Enter / Space)
        locationBadge.addEventListener('keydown', (ev) => {
            if(ev.key === 'Enter' || ev.key === ' '){
                ev.preventDefault();
                locationBadge.click();
            }
        });
    }

    // wire up search and filter to re-render product list
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    if(searchInput){ searchInput.addEventListener('input', renderProducts); }
    if(typeFilter){ typeFilter.addEventListener('change', renderProducts); }

    // initialize UI
    document.addEventListener('DOMContentLoaded', () => {
        updateRadiusLabel(document.getElementById('radiusSlider')?.value || 3);
        renderProducts();

        // ensure visual state of toggles matches initial checkbox values
        if(onlyInline) updateToggleVisual(onlyInline, toggleLabel);
        if(onlyOverlay) updateToggleVisual(onlyOverlay, toggleLabelOverlay);
    });
</script>

</body>
</html>
